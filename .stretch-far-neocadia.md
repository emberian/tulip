# Stretch Goal: Neocadia-Grade Game Platform

> **Status**: North star vision document
> **Builds on**: `.idempotent-sparkling-squirrel.md` (game widget brainstorming)
> **Inspired by**: `~/dev/neocadia/specs/` (full game design docs)

This document synthesizes the async RPG vision, Neocadia's minigame requirements, and a freeform + game kit architecture into a cohesive platform vision.

---

## The Vision

Tulip becomes a platform where **bots can run full games** - from simple async RPGs played over days, to arcade minigames played in minutes, to persistent virtual worlds explored over months.

**Three tiers of game complexity:**

| Tier | Example | Session | State | Rendering |
|------|---------|---------|-------|-----------|
| **Async RPG** | D&D campaign, Werewolf | Days/weeks | Bot-managed | Declarative widgets |
| **Session Games** | Poker night, Battleship | 30-60 min | Bot-managed | Hybrid |
| **Arcade/Action** | Pixel Invaders, Reel Deal | 5-15 min | Client-side | Full game engine |

All three should be possible on the same platform.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Tulip Client                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Chat View              â”‚         Game View                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Messages           â”‚     â”‚    â”‚   NeocadiaRuntime      â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚ â”‚ Inline Widget  â”‚â—„â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤â–º â”‚ Expanded Widget  â”‚  â”‚    â”‚
â”‚  â”‚ â”‚ (preview/mini) â”‚ â”‚     â”‚    â”‚  â”‚ (full experience)â”‚  â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚ â”‚ Async RPG turn â”‚ â”‚     â”‚    â”‚  â”‚ React + shadcn   â”‚  â”‚    â”‚
â”‚  â”‚ â”‚ (your move!)   â”‚ â”‚     â”‚    â”‚  â”‚ (UI overlays)    â”‚  â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                               â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP Events  â”‚             â”‚    WebSocket    â”‚      â”‚ Asset Server â”‚
â”‚ (async games) â”‚             â”‚ (real-time games)â”‚      â”‚ (sprites/sfx)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Game Bot     â”‚
              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
              â”‚ â”‚ World State â”‚ â”‚
              â”‚ â”‚ Player Data â”‚ â”‚
              â”‚ â”‚ Save System â”‚ â”‚
              â”‚ â”‚ Economy     â”‚ â”‚
              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Layer 1: Async RPG Support

For games played over hours/days with many players. Turn-based, narrative-focused.

### Core Features

**Per-User Views** (from brainstorming doc)
- Players see different content (their hand, their perspective)
- Ownership shorthand + explicit views
- Server resolves at send time

**Turn Management**
```json
{
  "game_state": {
    "phase": "combat",
    "current_turn": "user_123",
    "turn_order": ["user_123", "user_456", "user_789"],
    "time_limit": 86400,
    "actions_remaining": 1
  }
}
```

**Async-Friendly Patterns**
- Notifications when it's your turn (existing Zulip notifications)
- Catch-up summaries ("While you were away...")
- Timeout handling (auto-pass, AI takeover, pause)
- Late-join support for ongoing games

**Character/Entity System**
```json
{
  "characters": {
    "user_123": {
      "name": "Aldric the Bold",
      "class": "Warrior",
      "stats": {"hp": 45, "max_hp": 60, "str": 16, "dex": 12},
      "inventory": ["sword_iron", "potion_health", "shield_wooden"],
      "status_effects": [{"type": "poisoned", "duration": 2}]
    }
  }
}
```

**Narrative Integration**
- Rich embeds for story beats
- NPC dialog widgets
- Choice-based branching (buttons with consequences)
- GM/narrator role support

### Example: Async D&D Combat

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš”ï¸ COMBAT: Goblin Ambush                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Turn Order: [Aldric] â†’ Lyra â†’ Goblin Chief â†’ ...   â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ—ºï¸ Battlefield                               â”‚   â”‚
â”‚  â”‚  . . . G . . .                              â”‚   â”‚
â”‚  â”‚  . . G . G . .     G = Goblin               â”‚   â”‚
â”‚  â”‚  . . . . . . .     A = Aldric (you)         â”‚   â”‚
â”‚  â”‚  . A . . . L .     L = Lyra                 â”‚   â”‚
â”‚  â”‚  . . . . . . .                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  Aldric (You) - HP: 45/60 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘               â”‚
â”‚  Status: Poisoned (2 turns)                        â”‚
â”‚                                                     â”‚
â”‚  [âš”ï¸ Attack] [ğŸ›¡ï¸ Defend] [ğŸ§ª Use Item] [ğŸƒ Move]    â”‚
â”‚                                                     â”‚
â”‚  â±ï¸ 23:45:12 remaining                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Layer 2: Session Games

For games played in one sitting with real-time-ish interaction. Card games, board games, social deduction.

### Core Features

**Lobby/Matchmaking**
```json
{
  "widget_type": "lobby",
  "game": "Poker",
  "players": [
    {"id": "user_123", "name": "Alice", "ready": true},
    {"id": "user_456", "name": "Bob", "ready": false}
  ],
  "settings": {
    "buy_in": 100,
    "blind": 5
  },
  "min_players": 2,
  "max_players": 8
}
```

**Game Phases**
- Lobby â†’ Setup â†’ Playing â†’ Resolution â†’ Results
- Phase-appropriate UI for each
- Spectator mode with appropriate visibility

**Real-Time Feel**
- Partial updates (diffs) for responsive UI
- Client-side prediction for immediate feedback
- WebSocket upgrade for faster games

### Example: Poker Night

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â™ ï¸ TEXAS HOLD'EM - Pot: 150 tokens                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Community Cards:                                   â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                    â”‚
â”‚  â”‚ 7 â”‚ â”‚ K â”‚ â”‚ 2 â”‚ â”‚ ? â”‚ â”‚ ? â”‚                    â”‚
â”‚  â”‚ â™¥ï¸ â”‚ â”‚ â™ ï¸ â”‚ â”‚ â™¦ï¸ â”‚ â”‚   â”‚ â”‚   â”‚                    â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                    â”‚
â”‚                                                     â”‚
â”‚  Players:                                           â”‚
â”‚  Alice: 450 tokens [Dealer]                        â”‚
â”‚  Bob: 280 tokens â† current                         â”‚
â”‚  You: 320 tokens                                    â”‚
â”‚                                                     â”‚
â”‚  Your Hand:                                         â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                                       â”‚
â”‚  â”‚ A â”‚ â”‚ K â”‚  (Pair of Kings possible!)            â”‚
â”‚  â”‚ â™ ï¸ â”‚ â”‚ â™¥ï¸ â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                                       â”‚
â”‚                                                     â”‚
â”‚  [Fold] [Check] [Raise â–¼]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Layer 3: Arcade/Action Games (Neocadia-Grade)

For real-time minigames requiring 30-60fps, precise input, and game engine features.

### The NeocadiaRuntime

A game engine layer that runs inside freeform widgets:

```typescript
class NeocadiaRuntime {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CORE SYSTEMS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  input: InputManager;
  // - Keyboard: press, release, held states
  // - Mouse: position, click, drag, scroll
  // - Touch: tap, swipe, pinch, multi-touch
  // - Gamepad: future support
  // - Unified API across input types

  audio: AudioManager;
  // - Music: looping, crossfade, dynamic layers
  // - SFX: pooled, positional, concurrent
  // - Volume groups (master/music/sfx)
  // - Preloading and caching

  render: SpriteRenderer;
  // - Sprite batching for performance
  // - Layers with z-ordering
  // - Camera (pan, zoom, shake)
  // - Particle systems
  // - Shader effects (glow, CRT, etc.)

  physics: PhysicsSystem;
  // - Collision detection (circle, AABB, polygon)
  // - Spatial partitioning for performance
  // - Simple physics (velocity, gravity)
  // - Trigger zones

  time: TimeManager;
  // - Delta time for frame-independent logic
  // - Timers and delays
  // - Slow-motion / time scale
  // - Animation timing

  state: StateMachine;
  // - Game state management
  // - Transitions with effects
  // - State stack (pause menus, etc.)

  save: SaveBridge;
  // - Sync with bot for persistence
  // - Local caching for performance
  // - Auto-save on key events

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UI LAYER (React + shadcn)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ui: ReactBridge;
  // - Render React components over game canvas
  // - shadcn component library available
  // - HUD, menus, dialogs, inventory
  // - Seamless game â†” UI interaction
}
```

### Asset System

Games need lots of assets. Can't inline everything as base64.

```typescript
// Asset manifest registered by bot
{
  "asset_pack": "pixel-invaders",
  "assets": {
    "sprites": {
      "pi_ship": "/assets/games/pixel-invaders/ship.png",
      "pi_grunt": "/assets/games/pixel-invaders/grunt.png",
      // ...
    },
    "audio": {
      "sfx_shoot": "/assets/games/pixel-invaders/shoot.wav",
      "music_battle": "/assets/games/pixel-invaders/battle.mp3",
      // ...
    },
    "fonts": {
      "pixel": "/assets/fonts/pixel.woff2"
    }
  }
}

// In game code
const ship = runtime.render.sprite('pi_ship', {x: 200, y: 400});
runtime.audio.play('sfx_shoot');
```

**Asset hosting options:**
1. Bot serves assets from its own endpoint
2. Tulip hosts approved asset packs
3. CDN integration for performance

### Example: Pixel Invaders (from Neocadia specs)

```typescript
class PixelInvaders extends NeocadiaGame {
  ship: Sprite;
  bullets: Pool<Bullet>;
  enemies: Pool<Enemy>;
  score: number = 0;

  async init() {
    // Load assets
    await this.runtime.assets.load('pixel-invaders');

    // Create player
    this.ship = this.runtime.render.sprite('pi_ship', {
      x: this.width / 2,
      y: this.height - 50,
      layer: 'player'
    });

    // Set up input
    this.runtime.input.on('left', () => this.shipVelocity.x = -300);
    this.runtime.input.on('right', () => this.shipVelocity.x = 300);
    this.runtime.input.onRelease(['left', 'right'], () => this.shipVelocity.x = 0);
    this.runtime.input.on('shoot', () => this.fire());

    // Object pools for performance
    this.bullets = new Pool(() => new Bullet(this.runtime), 100);
    this.enemies = new Pool(() => new Enemy(this.runtime), 50);

    // Start music
    this.runtime.audio.playMusic('music_battle', {loop: true});

    // UI overlay
    this.runtime.ui.render(
      <GameHUD score={this.score} lives={this.lives} wave={this.wave} />
    );
  }

  update(dt: number) {
    // Move ship
    this.ship.x += this.shipVelocity.x * dt;
    this.ship.x = clamp(this.ship.x, 0, this.width);

    // Update bullets
    this.bullets.active.forEach(b => {
      b.y -= b.speed * dt;
      if (b.y < 0) this.bullets.release(b);
    });

    // Update enemies
    this.enemies.active.forEach(e => e.update(dt));

    // Collision detection
    this.checkCollisions();

    // Update UI
    this.runtime.ui.update({score: this.score});
  }

  fire() {
    const bullet = this.bullets.acquire();
    bullet.spawn(this.ship.x, this.ship.y - 20);
    this.runtime.audio.play('sfx_shoot');
  }
}
```

---

## Layer 4: World Navigation (Point-and-Click)

For Neocadia-style hub worlds with explorable zones.

### Scene System

```typescript
interface Scene {
  id: string;
  type: 'zone' | 'subarea' | 'game' | 'dialog';
  background: string;  // Asset ID
  hotspots: Hotspot[];
  npcs: NPC[];
  ambient: AmbientConfig;
  music: string;
}

interface Hotspot {
  id: string;
  bounds: Rectangle;
  type: 'door' | 'npc' | 'game' | 'object' | 'collect';
  target?: string;  // Scene ID or action
  label?: string;
  enabled: boolean;
  cursor: CursorType;
}
```

### Navigation Flow

```
Player clicks hotspot
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hotspot type?     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ door â†’ transition â”‚â”€â”€â†’ Load new scene
â”‚ npc â†’ dialog      â”‚â”€â”€â†’ Open dialog widget
â”‚ game â†’ launch     â”‚â”€â”€â†’ Start minigame
â”‚ object â†’ interact â”‚â”€â”€â†’ Post to bot
â”‚ collect â†’ pickup  â”‚â”€â”€â†’ Add to inventory
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scene Transitions

```typescript
async function transition(from: Scene, to: Scene) {
  // 1. Play exit animation
  await runtime.render.fadeOut(300);

  // 2. Unload current scene
  from.unload();

  // 3. Load new scene assets
  await runtime.assets.loadScene(to.id);

  // 4. Initialize new scene
  to.init();

  // 5. Play enter animation
  await runtime.render.fadeIn(300);

  // 6. Start ambient audio
  runtime.audio.crossfadeMusic(to.music, 1000);
}
```

### Example: Pixel Beach Navigation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PIXEL BEACH                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ğŸŒ…                                    â”‚   â”‚
â”‚  â”‚         ğŸ–ï¸                                              â”‚   â”‚
â”‚  â”‚                          ğŸŒŠ ğŸŒŠ ğŸŒŠ                        â”‚   â”‚
â”‚  â”‚    [Shack]                              [Pier] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”‚ Fishing
â”‚  â”‚      ğŸ¦€                                   â•±              â”‚   â”‚
â”‚  â”‚     PIXEL        [Sandcastle]          ğŸ£               â”‚   â”‚
â”‚  â”‚                      ğŸ°                                  â”‚   â”‚
â”‚  â”‚   [Shell Shore] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”‚ Memory Game
â”‚  â”‚      ğŸš ğŸš                                               â”‚   â”‚
â”‚  â”‚                    [Surfboard] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”‚ Wave Rider
â”‚  â”‚                        ğŸ„                                â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  [â† Back to Lobby]                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Tokens: 247  |  ğŸŸ Fish: 23/50  |  ğŸ† Beach: 45% restored     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## React + shadcn Integration

### Why React in Widgets?

1. **Component reuse** - Build once, use across games
2. **shadcn quality** - Beautiful, accessible components out of the box
3. **State management** - React handles UI state, game engine handles game state
4. **Familiar tooling** - Most web devs know React

### How It Works

```typescript
// Freeform widget loads React runtime
ctx.useReact();

// Game engine renders to canvas
const runtime = new NeocadiaRuntime(ctx.canvas);

// React renders UI overlay
ctx.renderUI(
  <GameShell>
    <HUD score={score} lives={lives} />
    <PauseMenu open={paused} onResume={resume} />
    <InventoryDrawer items={inventory} />
  </GameShell>
);
```

### shadcn Components for Games

```typescript
// Available out of the box:
import {
  Button,
  Card,
  Dialog,
  Drawer,
  DropdownMenu,
  Progress,
  Tabs,
  Tooltip,
  // ... full shadcn library
} from '@neocadia/ui';

// Game-specific components built on shadcn:
import {
  GameHUD,
  HealthBar,
  InventoryGrid,
  DialogBox,
  CharacterSheet,
  Leaderboard,
  LobbyCard,
  // ...
} from '@neocadia/game-ui';
```

### Example: Character Sheet (shadcn-based)

```tsx
function CharacterSheet({ character }: { character: Character }) {
  return (
    <Card className="w-96">
      <CardHeader>
        <CardTitle>{character.name}</CardTitle>
        <CardDescription>{character.class} - Level {character.level}</CardDescription>
      </CardHeader>
      <CardContent>
        <Tabs defaultValue="stats">
          <TabsList>
            <TabsTrigger value="stats">Stats</TabsTrigger>
            <TabsTrigger value="inventory">Inventory</TabsTrigger>
            <TabsTrigger value="skills">Skills</TabsTrigger>
          </TabsList>

          <TabsContent value="stats">
            <div className="space-y-2">
              <HealthBar current={character.hp} max={character.maxHp} />
              <ManaBar current={character.mp} max={character.maxMp} />
              <StatGrid stats={character.stats} />
            </div>
          </TabsContent>

          <TabsContent value="inventory">
            <InventoryGrid
              items={character.inventory}
              onItemClick={handleItemClick}
              onItemDrag={handleItemDrag}
            />
          </TabsContent>

          <TabsContent value="skills">
            <SkillTree skills={character.skills} />
          </TabsContent>
        </Tabs>
      </CardContent>
    </Card>
  );
}
```

---

## Communication Architecture

### Async Games (HTTP)

Standard Tulip event flow:
```
User interaction â†’ POST /json/bot_interactions â†’ Bot worker â†’ Bot responds â†’ Event broadcast
```

Latency: 50-200ms (acceptable for turn-based)

### Real-Time Games (WebSocket)

Direct connection for action games:
```
Widget â†â”€â”€WebSocketâ”€â”€â†’ Tornado â†â”€â”€Queueâ”€â”€â†’ Bot
```

**New endpoint**: `GET /ws/game/{message_id}`

```typescript
// Client
const ws = new WebSocket(`wss://${host}/ws/game/${messageId}`);
ws.onmessage = (e) => runtime.handleServerUpdate(JSON.parse(e.data));

// Send player input at 60Hz
setInterval(() => {
  ws.send(JSON.stringify({
    type: 'input',
    keys: runtime.input.getHeldKeys(),
    mouse: runtime.input.getMousePosition()
  }));
}, 16);
```

### Hybrid (Auto-Upgrade)

Widget starts with HTTP, upgrades if needed:

```typescript
if (gameConfig.realtime) {
  await this.upgradeToWebSocket();
} else {
  this.useHttpEvents();
}
```

---

## Data Flow

### Bot Responsibilities

```typescript
interface GameBot {
  // World state
  world: WorldState;

  // Per-player data
  players: Map<UserId, PlayerData>;

  // Game sessions
  sessions: Map<MessageId, GameSession>;

  // Methods
  handleInteraction(ctx: InteractionContext): Response;
  handleWebSocket(ctx: WSContext, message: WSMessage): void;
  getStateForPlayer(playerId: UserId): PlayerView;
  savePlayerData(playerId: UserId, data: PlayerData): void;
}
```

### Save System

```typescript
interface NeocadiaSave {
  // Account-level
  account: {
    tokens: number;
    totalPlayTime: number;
    achievements: string[];
  };

  // Per-zone progress
  zones: Record<ZoneId, {
    restoration: number;
    collectibles: string[];
    npcsDialogState: Record<NpcId, DialogState>;
  }>;

  // Per-minigame
  minigames: Record<GameId, {
    highScore: number;
    playCount: number;
    unlocks: string[];
    // Game-specific data
    extra: Record<string, any>;
  }>;

  // Active game states (for resume)
  activeSessions: Record<MessageId, GameState>;
}
```

---

## Implementation Phases

### Phase 0: Current State
- Freeform widgets with vanilla HTML/CSS/JS
- Bot interactions via HTTP
- Basic widget types (poll, todo, rich_embed, interactive)

### Phase 1: React Runtime
- Install React in freeform widget context
- Add shadcn component library
- Basic game UI components (HUD, menus)
- **Enables**: Better async RPG UIs, character sheets

### Phase 2: Game Engine Core
- NeocadiaRuntime with input/audio/render/physics
- Asset loading system
- State machine helpers
- **Enables**: Simple arcade games (Gear Garden level)

### Phase 3: WebSocket Channel
- Real-time communication for action games
- Input streaming at 60Hz
- Server-side game loop option
- **Enables**: Action games (Pixel Invaders level)

### Phase 4: Scene Navigation
- Point-and-click scene system
- Hotspot management
- Scene transitions
- **Enables**: Hub worlds, exploration

### Phase 5: Full Neocadia
- All minigames playable
- World state persistence
- Economy and progression
- **Enables**: Complete Neocadia experience in Tulip

---

## File Structure (Future)

```
tulip/
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ neocadia/
â”‚   â”‚   â”‚   â”œâ”€â”€ runtime/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ NeocadiaRuntime.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InputManager.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AudioManager.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SpriteRenderer.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PhysicsSystem.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StateMachine.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SaveBridge.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components/      # shadcn + game components
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GameShell.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ReactBridge.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ scenes/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SceneManager.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Hotspot.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Transition.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ freeform_widget.ts       # Enhanced to load Neocadia
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ neocadia.css
â”œâ”€â”€ zerver/
â”‚   â”œâ”€â”€ tornado/
â”‚   â”‚   â””â”€â”€ game_websocket.py        # WebSocket handler
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ game_assets.py           # Asset manifest handling
```

---

## Success Criteria

**Phase 1 Complete When:**
- [ ] React renders inside freeform widget
- [ ] shadcn components available and styled
- [ ] Can build a character sheet with tabs, progress bars, inventory grid

**Phase 2 Complete When:**
- [ ] Gear Garden playable in Tulip
- [ ] 30fps stable with sprites and collision
- [ ] Audio plays correctly

**Phase 3 Complete When:**
- [ ] Pixel Invaders playable in Tulip
- [ ] 60fps with 100+ sprites
- [ ] Input latency < 50ms via WebSocket

**Phase 4 Complete When:**
- [ ] Pixel Beach navigable
- [ ] Can walk between areas
- [ ] NPCs trigger dialogs

**Phase 5 Complete When:**
- [ ] Full Neocadia MVP playable
- [ ] Lobby + 2 zones + 6 minigames
- [ ] Save/load works
- [ ] Token economy functional

---

## Open Questions

1. **Asset hosting** - Who hosts game assets? Bot? Tulip? CDN?

2. **Mobile support** - Touch controls for all games? Responsive layouts?

3. **Multiplayer minigames** - Can two players play Pixel Invaders together?

4. **Offline support** - Cache game assets for offline play?

5. **Moderation** - How to handle inappropriate user-generated game content?

6. **Performance budget** - What's the max complexity before we say "use a real game engine"?

---

## The Dream

A player opens Tulip. In one channel, they're playing an async D&D campaign with friends - it's their turn to attack the dragon. In another channel, they duck into Neocadia's Pixel Beach to fish for a few minutes while waiting. They catch a rare Shader Shark, earn some tokens, and head back to the Lobby to check their restoration progress.

All of it happens inside a chat app. The games are the conversation. The conversation is the game.

That's the stretch goal.
